<!--pages/search/search.wxml-->
<view class="container">
  <!-- åˆå§‹åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{initialLoading}}" class="initial-loading">
    <!-- ä½¿ç”¨éª¨æ¶å±ç»„ä»¶ -->
    <skeleton type="search" />
  </view>

  <!-- ä¸»è¦å†…å®¹ï¼ˆæ•°æ®åŠ è½½å®Œæˆåæ˜¾ç¤ºï¼‰ -->
  <view wx:else>
    <!-- å›ºå®šé¡¶éƒ¨åŒºåŸŸ -->
    <view class="fixed-header">
    <!-- å®‰å…¨åŒºåŸŸå ä½ -->
    <view class="safe-area-top" style="height: {{safeAreaTop}}px;"></view>
    
    <!-- æ ‡é¢˜æ  -->
    <view class="header">
      <text class="header-title">è‚¡å€¼é€š</text>
    </view>
    
    <!-- æœç´¢æ  -->
    <view class="search-header">
      <view class="search-input-wrapper {{keyword || showResults ? '' : 'full-width'}}">
        <text class="search-icon">ğŸ”</text>
        <input 
          class="search-input"
          placeholder="æœç´¢è‚¡ç¥¨ä»£ç æˆ–åç§°"
          value="{{keyword}}"
          bindinput="onInputChange"
          confirm-type="search"
        />
        <text 
          wx:if="{{keyword}}"
          class="clear-icon"
          bindtap="onClearInput"
        >âœ•</text>
      </view>
      <text 
        wx:if="{{keyword || showResults}}"
        class="cancel-btn" 
        bindtap="onCancel"
      >å–æ¶ˆ</text>
    </view>

    <!-- æ ‡ç­¾æ  -->
    <view wx:if="{{!showResults}}" class="tab-header">
      <view 
        class="tab-item {{currentTab === 'hot' ? 'active' : ''}}"
        data-tab="hot"
        bindtap="onTabChange"
      >
        çƒ­é—¨è‚¡ç¥¨
      </view>
      <view 
        class="tab-item {{currentTab === 'recent' ? 'active' : ''}}"
        data-tab="recent"
        bindtap="onTabChange"
      >
        æœ€è¿‘æŸ¥çœ‹
      </view>
      <view 
        class="tab-item {{currentTab === 'favorites' ? 'active' : ''}}"
        data-tab="favorites"
        bindtap="onTabChange"
      >
        æˆ‘çš„è‡ªé€‰
      </view>
    </view>
  </view>

  <!-- å¯æ»šåŠ¨å†…å®¹åŒºåŸŸ -->
  <view class="scrollable-content">

  <!-- æœç´¢ç»“æœ -->
  <view wx:if="{{showResults}}" class="search-results">
    <!-- åŠ è½½ä¸­ -->
    <view wx:if="{{loading}}" class="loading">
      <loading></loading>
      <text class="loading-text">æœç´¢ä¸­...</text>
    </view>
    
    <!-- æœç´¢ç»“æœåˆ—è¡¨ -->
    <view wx:elif="{{searchResults.length > 0}}" class="results-list">
      <view 
        wx:for="{{searchResults}}" 
        wx:key="symbol"
        class="result-item"
        data-stock="{{item}}"
        data-index="{{index}}"
        bindtap="onResultTap"
      >
        <view class="stock-info">
          <view class="stock-name">{{item.name}}</view>
          <view class="stock-code">{{item.symbol}}</view>
        </view>
        <view wx:if="{{item.price}}" class="stock-price">
          <view class="price">Â¥{{item.price}}</view>
          <view class="price-change {{item.change >= 0 ? 'text-success' : 'text-danger'}}">
            {{item.change >= 0 ? '+' : ''}}{{item.change}} ({{item.change >= 0 ? '+' : ''}}{{item.changePercent}}%)
          </view>
        </view>
      </view>
    </view>
    
    <!-- æ— ç»“æœ -->
    <view wx:else class="empty-results">
      <text class="empty-icon">ğŸ“­</text>
      <text class="empty-text">æœªæ‰¾åˆ°ç›¸å…³è‚¡ç¥¨</text>
      <text class="empty-tip">è¯·å°è¯•ä½¿ç”¨è‚¡ç¥¨ä»£ç æˆ–å®Œæ•´åç§°æœç´¢</text>
    </view>
  </view>

    <!-- é»˜è®¤å†…å®¹ -->
    <view wx:else class="default-content">
      <!-- æ ‡ç­¾é¡µå†…å®¹ -->
      <swiper 
        class="tab-swiper"
        current="{{currentTabIndex}}"
        bindchange="onSwiperChange"
        duration="300"
        easing-function="easeInOutCubic"
      >
        <!-- çƒ­é—¨è‚¡ç¥¨ -->
        <swiper-item class="tab-panel">
          <!-- åŠ è½½çŠ¶æ€ -->
          <view wx:if="{{hotStocksLoading}}" class="hot-stocks-loading">
            <loading size="mini"></loading>
            <text class="loading-text-small">åŠ è½½ä¸­...</text>
          </view>
          
          <!-- åŠ è½½å¤±è´¥çŠ¶æ€ -->
          <view wx:elif="{{hotStocksLoadFailed && hotStocks.length === 0}}" class="hot-stocks-error">
            <text class="error-icon">ğŸ“¡</text>
            <text class="error-text">åŠ è½½å¤±è´¥</text>
            <text class="error-tip">ç½‘ç»œä¸ç»™åŠ›ï¼Œç‚¹å‡»é‡è¯•</text>
            <button class="retry-btn" bindtap="retryLoadHotStocks">é‡è¯•</button>
          </view>
          
          <!-- çƒ­é—¨è‚¡ç¥¨åˆ—è¡¨ -->
          <view wx:else class="hot-stocks-list">
            <view 
              wx:for="{{hotStocks}}" 
              wx:key="name"
              class="hot-stock-item"
              data-stock="{{item}}"
              data-index="{{index}}"
              bindtap="onHotStockTap"
            >
              <view class="hot-stock-rank">{{item.rank}}</view>
              <view class="hot-stock-info">
                <text class="hot-stock-name">{{item.name}}</text>
                <text 
                  wx:if="{{item.changePercent}}" 
                  class="hot-stock-change {{item.changePercent.indexOf('-') === 0 ? 'text-danger' : 'text-success'}}"
                >
                  {{item.changePercent}}
                </text>
                <text wx:else class="hot-stock-code">{{item.symbol}}</text>
              </view>
            </view>
          </view>
        </swiper-item>
        
        <!-- æœ€è¿‘æŸ¥çœ‹ -->
        <swiper-item class="tab-panel">
          <view wx:if="{{recentSearches.length > 0}}">
            <view class="recent-header">
              <text class="clear-all-btn" bindtap="clearAllRecentSearches">æ¸…ç©ºå…¨éƒ¨</text>
            </view>
            <view class="recent-searches">
              <view 
                wx:for="{{recentSearches}}" 
                wx:key="symbol"
                class="recent-item"
                data-stock="{{item}}"
                bindtap="onRecentTap"
              >
                <view class="recent-info">
                  <view class="recent-name">{{item.name}}</view>
                  <view class="recent-code">{{item.symbol}}</view>
                </view>
                <text 
                  class="delete-icon"
                  data-index="{{index}}"
                  catchtap="deleteRecentItem"
                >âœ•</text>
              </view>
            </view>
          </view>
          
          <!-- æ— æœ€è¿‘æŸ¥çœ‹ -->
          <view wx:else class="empty-recent">
            <text class="empty-icon">ğŸ•’</text>
            <text class="empty-text">æš‚æ— æœç´¢è®°å½•</text>
            <text class="empty-tip">æœç´¢è¿‡çš„è‚¡ç¥¨ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</text>
          </view>
        </swiper-item>
        
        <!-- æˆ‘çš„è‡ªé€‰ -->
        <swiper-item class="tab-panel">
          <view wx:if="{{favoriteStocks.length > 0}}">
            <view class="favorites-header">
              <text class="favorites-count">å…± {{favoriteStocks.length}} åªè‚¡ç¥¨</text>
              <text class="clear-all-btn" bindtap="clearAllFavorites">æ¸…ç©ºå…¨éƒ¨</text>
            </view>
            <view class="favorite-stocks">
              <view 
                wx:for="{{favoriteStocks}}" 
                wx:key="symbol"
                class="favorite-item"
                data-stock="{{item}}"
                bindtap="onFavoriteTap"
              >
                <view class="favorite-info">
                  <view class="favorite-name">{{item.name}}</view>
                  <view class="favorite-details">
                    <text class="favorite-code">{{item.symbol}}</text>
                  </view>
                </view>
                <text 
                  class="delete-icon"
                  data-index="{{index}}"
                  catchtap="deleteFavoriteItem"
                >âœ•</text>
              </view>
            </view>
          </view>
          
          <!-- æ— è‡ªé€‰ -->
          <view wx:else class="empty-favorites">
            <text class="empty-icon">ğŸ’¼</text>
            <text class="empty-text">æš‚æ— è‡ªé€‰</text>
            <text class="empty-tip">æœç´¢å¹¶åŠ å…¥æ„Ÿå…´è¶£çš„è‚¡ç¥¨</text>
          </view>
        </swiper-item>
      </swiper>
    </view>
  </view>
  </view>
</view>