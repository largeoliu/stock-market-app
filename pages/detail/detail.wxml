<!--pages/detail/detail.wxml-->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading">
    <loading></loading>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- ä¸»è¦å†…å®¹ -->
  <view wx:else>
    <!-- è‚¡ç¥¨ä¿¡æ¯ -->
    <view class="stock-header card">
      <view class="stock-basic-info">
        <view class="stock-name">{{stock.name}}</view>
        <view class="stock-code">{{stock.symbol}}</view>
      </view>
      <view class="stock-actions">
        <button 
          class="action-btn {{isFavorited ? 'favorited' : ''}}"
          bindtap="onToggleFavorite"
        >
          <text class="action-icon">{{isFavorited ? 'â¤ï¸' : 'ğŸ¤'}}</text>
          {{isFavorited ? 'å·²åŠ è‡ªé€‰' : 'åŠ å…¥è‡ªé€‰'}}
        </button>
      </view>
    </view>

    <!-- æ•°æ®ç±»å‹å’Œæ—¶é—´èŒƒå›´é€‰æ‹© -->
    <view class="selector-section card">
      <!-- æ•°æ®ç±»å‹åˆ‡æ¢ -->
      <view class="data-type-selector">
        <view class="selector-title">æ•°æ®ç±»å‹</view>
        <view class="data-type-buttons">
          <view 
            wx:for="{{dataTypes}}" 
            wx:key="key"
            class="data-type-btn {{item.active ? 'active' : ''}}"
            data-type="{{item.key}}"
            bindtap="onDataTypeChange"
          >
            {{item.label}}
          </view>
        </view>
      </view>

      <!-- å½“å‰æ•°å€¼æ˜¾ç¤º -->
      <view class="current-value" wx:if="{{currentDataType === 'marketCap'}}">
        <view class="value-label">å½“å‰å¸‚å€¼ï¼ˆäº¿ï¼‰</view>
        <view class="value-number">{{stats.currentMarketCapFormatted}}</view>
      </view>
      <view class="current-value" wx:elif="{{currentDataType === 'actualTurnover'}}">
        <view class="value-label">å½“å‰å®é™…æ¢æ‰‹ç‡</view>
        <view class="value-number">{{turnoverStats.currentTurnover}}%</view>
      </view>
      
      <!-- æ—¶é—´èŒƒå›´é€‰æ‹© -->
      <view class="period-title">æ—¶é—´èŒƒå›´</view>
      <view class="period-selector-container">
        <view class="period-selector-track">
          <!-- æ»‘åŠ¨æŒ‡ç¤ºå™¨èƒŒæ™¯ -->
          <view 
            class="period-selector-indicator" 
            style="transform: translateX({{indicatorPosition}}rpx); width: {{indicatorWidth}}rpx;"
          ></view>
          
          <!-- é€‰é¡¹æŒ‰é’® -->
          <view 
            wx:for="{{periods}}" 
            wx:key="key"
            class="period-selector-item {{item.active ? 'active' : ''}}"
            data-period="{{item.key}}"
            data-index="{{index}}"
            bindtap="onPeriodChange"
          >
            <text class="period-label">{{item.label}}</text>
          </view>
        </view>
      </view>
      
      <!-- ç»Ÿè®¡ä¿¡æ¯ -->
      <view class="stats-grid" wx:if="{{currentDataType === 'marketCap'}}">
        <view class="stat-item">
          <view class="stat-label">å½“å‰å¸‚å€¼åˆ†ä½</view>
          <view class="stat-value primary">
            {{stats.percentile}}%
          </view>
        </view>
        <view class="stat-item">
          <view class="stat-label">æœ€é«˜å¸‚å€¼</view>
          <view class="stat-value">{{stats.maxMarketCapFormatted}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">æœ€ä½å¸‚å€¼</view>
          <view class="stat-value">{{stats.minMarketCapFormatted}}</view>
        </view>
      </view>
      
      <view class="stats-grid" wx:elif="{{currentDataType === 'actualTurnover'}}">
        <view class="stat-item">
          <view class="stat-label">å½“å‰åˆ†ä½</view>
          <view class="stat-value primary">
            {{turnoverStats.percentile}}%
          </view>
        </view>
        <view class="stat-item">
          <view class="stat-label">æœ€é«˜</view>
          <view class="stat-value">{{turnoverStats.maxTurnover}}%</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">æœ€ä½</view>
          <view class="stat-value">{{turnoverStats.minTurnover}}%</view>
        </view>
      </view>
    </view>

    <!-- å›¾è¡¨åŒºåŸŸ -->
    <view class="chart-section card">
      <view class="chart-title">
        {{currentDataType === 'marketCap' ? 'å¸‚å€¼èµ°åŠ¿å›¾' : 'å®é™…æ¢æ‰‹ç‡èµ°åŠ¿å›¾'}}
        <view wx:if="{{chartLoading}}" class="chart-loading">
          <loading size="mini"></loading>
          <text class="loading-text-small">æ›´æ–°ä¸­...</text>
        </view>
      </view>
      
      <view class="chart-container">
        <simple-chart 
          data="{{ chartData }}"
          x-data="{{ chartXData }}"
          width="{{ screenWidth }}"
          height="250"
          dataType="{{ currentDataType }}"
        ></simple-chart>
      </view>
    </view>

    <!-- ç¨³å®šè‚¡ä¸œä¿¡æ¯ -->
    <view class="stable-shareholders-section card">
      <view class="section-title">ç¨³å®šè‚¡ä¸œæŒè‚¡å æ¯”</view>
      
      <!-- åŠ è½½çŠ¶æ€ -->
      <view wx:if="{{stableShareholders.loading}}" class="shareholders-loading">
        <loading size="mini"></loading>
        <text class="loading-text-small">åŠ è½½ä¸­...</text>
      </view>
      
      <!-- ç¨³å®šè‚¡ä¸œæ•°æ® -->
      <view wx:elif="{{stableShareholders.data}}" class="shareholders-content">
        <!-- æ€»ä½“ç»Ÿè®¡ -->
        <view class="shareholders-summary">
          <view class="summary-item">
            <text class="summary-label">ç¨³å®šè‚¡ä¸œæ•°é‡</text>
            <text class="summary-value">{{stableShareholders.data.stable_shareholders.length}}å®¶</text>
          </view>
          <view class="summary-item">
            <text class="summary-label">æ€»æŒè‚¡å æ¯”</text>
            <text class="summary-value primary">{{stableShareholders.data.total_stable_ratio}}%</text>
          </view>
        </view>
        
        <!-- ç¨³å®šè‚¡ä¸œåˆ—è¡¨ -->
        <view wx:if="{{stableShareholders.data.stable_shareholders.length > 0}}" class="shareholders-list">
          <view class="list-header">
            <text class="list-title">ä¸»è¦ç¨³å®šè‚¡ä¸œ</text>
          </view>
          <view 
            wx:for="{{stableShareholders.data.stable_shareholders}}" 
            wx:key="shareholder_name"
            class="shareholder-item"
          >
            <view class="shareholder-name">{{item.shareholder_name}}</view>
            <view class="shareholder-meta">
              <text class="meta-item">{{item.latest_holding_ratio}}%</text>
            </view>
          </view>
        </view>
      </view>
      
      <!-- é”™è¯¯çŠ¶æ€ -->
      <view wx:elif="{{stableShareholders.error}}" class="shareholders-error">
        <text class="error-text">æš‚æ— ç¨³å®šè‚¡ä¸œæ•°æ®</text>
      </view>
    </view>

    <!-- å†å²æ•°æ®åˆ—è¡¨ï¼ˆå¯é€‰æ˜¾ç¤ºï¼‰ -->
    <view wx:if="{{historyData.length > 0 && historyData.length <= 50}}" class="history-list card">
      <view class="list-title">å†å²æ•°æ®</view>
      <view class="history-items">
        <view 
          wx:for="{{historyData}}" 
          wx:key="date"
          wx:for-index="index"
          class="history-item"
        >
          <view class="history-date">{{item.date}}</view>
          <view class="history-value">{{item.marketCapFormatted}}</view>
        </view>
      </view>
    </view>
  </view>
</view>