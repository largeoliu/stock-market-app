<!--pages/detail/detail.wxml-->
<view class="container">
  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading">
    <loading></loading>
    <text class="loading-text">加载中...</text>
  </view>

  <!-- 主要内容 -->
  <view wx:else>
    <!-- 股票信息 -->
    <view class="stock-header card">
      <view class="stock-basic-info">
        <view class="stock-name">{{stock.name}}</view>
        <view class="stock-code">{{stock.symbol}} · {{stock.market}}</view>
      </view>
      <view class="stock-actions">
        <button 
          class="action-btn {{isFavorited ? 'favorited' : ''}}"
          bindtap="onToggleFavorite"
        >
          <text class="action-icon">{{isFavorited ? '❤️' : '🤍'}}</text>
          {{isFavorited ? '已收藏' : '收藏'}}
        </button>
      </view>
    </view>

    <!-- 时间范围选择 -->
    <view class="period-selector card">
      <!-- 当前市值 -->
      <view class="current-market-cap">
        <view class="market-cap-label">当前市值（亿）</view>
        <view class="market-cap-value">{{stats.currentMarketCapFormatted}}</view>
      </view>
      
      <view class="period-title">时间范围</view>
      <view class="period-selector-container">
        <view class="period-selector-track">
          <!-- 滑动指示器背景 -->
          <view 
            class="period-selector-indicator" 
            style="transform: translateX({{indicatorPosition}}rpx); width: {{indicatorWidth}}rpx;"
          ></view>
          
          <!-- 选项按钮 -->
          <view 
            wx:for="{{periods}}" 
            wx:key="key"
            class="period-selector-item {{item.active ? 'active' : ''}}"
            data-period="{{item.key}}"
            data-index="{{index}}"
            bindtap="onPeriodChange"
          >
            <text class="period-label">{{item.label}}</text>
          </view>
        </view>
      </view>
      
      <!-- 市值统计 -->
      <view class="stats-grid">
        <view class="stat-item">
          <view class="stat-label">当前市值分位</view>
          <view class="stat-value primary">
            {{stats.percentile}}%
          </view>
        </view>
        <view class="stat-item">
          <view class="stat-label">最高市值</view>
          <view class="stat-value">{{stats.maxMarketCapFormatted}}</view>
        </view>
        <view class="stat-item">
          <view class="stat-label">最低市值</view>
          <view class="stat-value">{{stats.minMarketCapFormatted}}</view>
        </view>
      </view>
    </view>

    <!-- 图表区域 -->
    <view class="chart-section card">
      <view class="chart-title">
        市值走势图
        <view wx:if="{{chartLoading}}" class="chart-loading">
          <loading size="mini"></loading>
          <text class="loading-text-small">更新中...</text>
        </view>
      </view>
      
      <view class="chart-container">
        <simple-chart 
          data="{{ chartData }}"
          x-data="{{ chartXData }}"
          width="{{ screenWidth }}"
          height="250"
        ></simple-chart>
      </view>
    </view>

    <!-- 稳定股东信息 -->
    <view class="stable-shareholders-section card">
      <view class="section-title">稳定股东持股比例</view>
      
      <!-- 加载状态 -->
      <view wx:if="{{stableShareholders.loading}}" class="shareholders-loading">
        <loading size="mini"></loading>
        <text class="loading-text-small">加载中...</text>
      </view>
      
      <!-- 稳定股东数据 -->
      <view wx:elif="{{stableShareholders.data}}" class="shareholders-content">
        <!-- 总体统计 -->
        <view class="shareholders-summary">
          <view class="summary-item">
            <text class="summary-label">稳定股东数量</text>
            <text class="summary-value">{{stableShareholders.data.stable_shareholders_count}}家</text>
          </view>
          <view class="summary-item">
            <text class="summary-label">总持股比例</text>
            <text class="summary-value primary">{{stableShareholders.data.total_stable_ratio}}%</text>
          </view>
          <view class="summary-item">
            <text class="summary-label">分析年数</text>
            <text class="summary-value">{{stableShareholders.data.analysis_years}}年</text>
          </view>
        </view>
        
        <!-- 稳定股东列表 -->
        <view wx:if="{{stableShareholders.data.stable_shareholders.length > 0}}" class="shareholders-list">
          <view class="list-header">
            <text class="list-title">主要稳定股东</text>
          </view>
          <view 
            wx:for="{{stableShareholders.data.stable_shareholders}}" 
            wx:key="shareholder_name"
            class="shareholder-item"
          >
            <view class="shareholder-info">
              <view class="shareholder-name">{{item.shareholder_name}}</view>
              <view class="shareholder-meta">
                <text class="meta-item">持股{{item.current_ownership_ratio}}%</text>
                <text class="meta-item">稳定性{{item.stability_score}}分</text>
              </view>
            </view>
            <view class="stability-indicator">
              <view class="stability-bar">
                <view class="stability-fill" style="width: {{item.stability_score}}%"></view>
              </view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- 错误状态 -->
      <view wx:elif="{{stableShareholders.error}}" class="shareholders-error">
        <text class="error-text">暂无稳定股东数据</text>
      </view>
    </view>

    <!-- 历史数据列表（可选显示） -->
    <view wx:if="{{historyData.length > 0 && historyData.length <= 50}}" class="history-list card">
      <view class="list-title">历史数据</view>
      <view class="history-items">
        <view 
          wx:for="{{historyData}}" 
          wx:key="date"
          wx:for-index="index"
          class="history-item"
        >
          <view class="history-date">{{item.date}}</view>
          <view class="history-value">{{item.marketCapFormatted}}</view>
        </view>
      </view>
    </view>
  </view>
</view>